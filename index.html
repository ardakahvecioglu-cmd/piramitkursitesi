<script>
function el(id){ return document.getElementById(id); }

let cache = { usd:null };
let last = {};

function applyChange(id,val){
  const e = el(id);
  const v = Number(val);
  if(!e) return;
  if(!isFinite(v)){ e.textContent="--"; e.className="value"; return; }

  const prev = last[id];
  last[id] = v;
  e.textContent = v.toFixed(2);

  if(prev === undefined){ e.className = "value"; return; }
  if(v > prev) e.className = "value up";
  else if(v < prev) e.className = "value down";
  else e.className = "value";
}

function fetchJSON(url){
  return fetch(url).then(r => r.json());
}

// USD bazlı, açık ve stabil bir API kullanıyoruz
// https://open.er-api.com/v6/latest/USD
async function fetchRates(){
  try{
    const fx = await fetchJSON("https://open.er-api.com/v6/latest/USD");

    if(!fx || fx.result === "error" || !fx.rates){
      console.error("Kur verisi hatalı:", fx);
      return;
    }

    const r = fx.rates;

    // 1 USD = r.TRY TL
    const usdtry = r.TRY;
    if(!isFinite(usdtry)){
      console.error("TRY kuru yok:", r);
      return;
    }

    // 1 USD = r.EUR EUR  => 1 EUR = usdtry / r.EUR TL
    const eurtry = usdtry / r.EUR;
    const gbptry = usdtry / r.GBP;

    cache.usd = usdtry;

    applyChange("usd", usdtry);
    applyChange("eur", eurtry);
    applyChange("gbp", gbptry);

    el("time").textContent =
      "Son güncelleme: " + new Date().toLocaleTimeString("tr-TR");

    fetchGold(); // kurlar geldikten sonra altını hesapla
  }catch(e){
    console.error("Döviz hatası:", e);
  }
}

async function fetchGold(){
  try{
    if(!cache.usd) return;

    const data = await fetchJSON("https://data-asg.goldprice.org/dbXRates/USD");
    const ons = data?.items?.[0]?.xauPrice;

    if(!isFinite(ons)){
      console.error("Ons verisi hatalı:", data);
      return;
    }

    const gram = (ons * cache.usd) / 31.1035;
    applyChange("gold", gram);
  }catch(e){
    console.error("Altın hatası:", e);
  }
}

window.addEventListener("load", fetchRates);
setInterval(fetchRates, 60_000);
</script>
